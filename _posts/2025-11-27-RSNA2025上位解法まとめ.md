---
layout: article
title: RSNA2025上位解法まとめ
author: K. Hikaru
tags:
  - Kaggle
date: '2025-11-29'
published: false
---
# はじめに

[RSNA Intracranial Aneurysm Detection](https://www.kaggle.com/competitions/rsna-intracranial-aneurysm-detection/overview)というKaggleのコンペに参加しました。自分の復習も兼ねて上位（1st-9th）の解法を読んだので、それをまとめます。

筆者がポンコツなので、記事にミスがある、重要なところを見逃している可能性があります。記事の最後に各解法のリンクをつけていますので、参考にしてください。（間違いに気づいたらこっそり教えてください）

### その他の工夫など


# コンペ概要

## 説明

- 頭蓋内脳動脈瘤は世界人口の3％に影響を与え、毎年50万人以上が亡くなっており、その約半数は50歳未満です。

- 今回のコンペでは様々な施設から得られたデータを用いて、実際の臨床的なバイアス（施設ごとの機械の差や、画像のコントラストの違いなど）を考慮した汎用的なモデルの構築が課題とされました。

- 評価は、動脈瘤が存在するか(AP)と、脳動脈瘤の位置に対応した13個のラベル合わせて14個のラベルについてのAUCスコアになります。


## データ

学習にはCTA、MRA、T1MRI、T2MRIなどの様々なモダリティで撮影された約4000人分の画像が提供されました。

- seriesは各患者一人ごとに与えられ、このseriesの中に頭部全体の画像が並べられています。データ形式はdicomでした。

- `train.csv`には動脈瘤の有無と13個の位置についての情報のラベル、その他年齢や性別といった情報も載せられていました。

- `train_localizer.csv`で動脈瘤の中心座標が与えられていました。

- 一部のseries(200個くらい)には、血管セグメンテーションも提供されていました。

# 上位解法まとめ
- どのチームも、マルチステージを採用していました。
- 
## 1位解法
### 1st stage
![image.png]({{ site.baseurl }}/assets/images/1764402539603-image.png)

 #### Preprocessed volume 
-  dicomデータをNIfTIに変換、そのあと座標系をRAS揃えて読み込み、nnUnetの前処理を加えています。

#### Coare Scan
-  脳スキャンデータを等方1mmにリサンプリングして粗いnnU-Net(Model1)に放りこみます。このモデルは出力として各ボクセルに対して、13+1クラスではなく4クラスのラベル（0:背景 + 3つの血管グループ）を返します。
- 後処理として、①ラベルを血管あり/血管なしの2値化をして,、②血管ありのボクセルの座標をすべて読み取り、③`DBSCAN`を用いてクラスタリングを施し、④一番大きいクラスタの中心座標を求め、⑤その座標を中心とした140mmのROIをクロップしてボクセルに変換しています。

#### Fine Inference
- 先ほど頑張って取得したROIを(0.80, 0.45, 0.44)にリサンプリングします(この数値は、nnU-Netの学習結果から持ってきたそうです) 。このROIを設定の違うnnU-NetであるModel2とModel3に入力します。

- Model2は損失関数がDice + CE + SkeltonRecall(weight=1)でModel3はTversky + CE + SkeltonRecall(weight=3)です。前者ではバランス重視、後者では見逃しをなくすのが狙いといった感じなのだと思います。

- `ROI refine`では、Model2のセグメンテーションの結果から最小のbboxを作成し、それにmarginを加えてROIを作成します。それを分類モデルの入力サイズに合わせて補完して、Final ROIが作成されます。この時、同時に13クラスの血管マスクとをModel2とModel3それぞれから出力しています。

### 2nd stage
#### nnU-Net Backbone
![image.png]({{ site.baseurl }}/assets/images/1764412257679-image.png)

- この図は、先ほどの出力をどのようにして最終的な予測に変えているかを表しています。

- 左上のROI Volumeが先ほどのFinal ROIに対応しています。Vessel maskはModel2/3の出力を合わせたものです。

- nnU-Net Backboneでは、`1 × 128 × 256 × 256`のROIからエンコーダ層の最後で`320 × 8 × 8 × 8`の出力を、デコーダ層の最後で`64 × 64 × 128 × 128`の出力を与えています。前者は最終的にROIの特徴を集約した64次元のベクトルになり、後者は補助タスクやUnion(動脈瘤が存在するかどうか)、13クラスの推定に使われています。

- `Aneurysm Detection Head`では、nnU-Netのデコーダ層の特徴に対してConvヘッドをつけ、補助ロスを計算しています。
#### Vessel Region-Masked Pooling
![image.png]({{ site.baseurl }}/assets/images/1764414914932-image.png)

-  この図は、先ほどの図にもあった`Vessel Region-Masked Pooling`を解説しています。Vessel Maskをダウンサンプリングしてデコーダと形をそろえ、Decoderの特徴量と掛けます。Maskは0-1の値をとるので、ここで掛けることで、例えばMaskが0のところの特徴は0に、Maskが1のところの特徴は1になり、どこにモデルが注目したらいいかがわかりやすくなります。掛けた特徴量を各チャネルでマスク内の平均をとり出力とします。

- 一個前の図ではUnionとありましたが、これは13クラスを動脈瘤が存在するかどうかの1クラスにまとめているだけで、あとは同じです。

#### Location-Aware Transformer
![image.png]({{ site.baseurl }}/assets/images/1764416118197-image.png)

- この図は、2つ前の図にあった`Location-Aware Transformer`の入力について解説しているものです。
- 緑の特徴量は、先ほどの血管マスクで取得した特徴量です。それに、nnU-Netのエンコーダ層からとってきた特徴量を13か所分コピーします。それを`Linear Projection`ブロックで、Transformer用の埋め込みベクトルにしています。

### その他の工夫など
- フェイルセーフ機構を用いて、セグメンテーションあるいはROI抽出で異常が発生した場合はoofの確率を返すようにしていた。
- 推論時にはTTAを使用していた。
- データには強いAugmentationをかけていた。
- TensorRTで高速化していた。

## 2位解法

## 3位解法

## 4位解法

## 5位解法

## 6位解法

## 7位解法

